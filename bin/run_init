#! /bin/sh
# (c) Copyright 2019-2022, James Stevens ... see LICENSE for details
# Alternative license arrangements possible, contact me for more information

if test -z "${BIND_TSIG_UPDATE_KEY}"
	then
		export BIND_TSIG_UPDATE_KEY="$(dd if=/dev/urandom bs=1 count=50 2>/dev/null | base64 )"
	fi

if test -z "${BIND_RNDC_KEY}"
	then
		export BIND_RNDC_KEY="$(dd if=/dev/urandom bs=1 count=50 2>/dev/null | base64 )"
	fi

export PDNS_API_KEY="$(dd if=/dev/urandom bs=1 count=50 2>/dev/null | base64 | tr -d $'\n +=./')"
if ! test "${PDNS_LOG_LEVEL}"; then export PDNS_LOG_LEVEL=5; fi
if ! test "${PDNS_LOG_FACILITY}"; then export PDNS_LOG_FACILITY=6; fi
if ! test "${PDNS_CATALOG_ZONE}"; then export PDNS_CATALOG_ZONE="lst.zz"; fi

export BIND_SECONDARY_SERVERS=""
if test "${DNS_SECONDARY_SERVERS}"
	then
		export BIND_SECONDARY_SERVERS=$(echo "${DNS_SECONDARY_SERVERS}" | awk '{ for(l=1;l<=NF;l++) x = x _ ";" _ $l; print(substr(x,2)) }')
	fi

for file in /usr/local/etc/*.tmpl
do
	/usr/local/bin/envsub < ${file} > /run/$(basename ${file} .tmpl).conf
done

if test "${MYSQL_CONNECT}" -a "${MYSQL_DATABASE}" -a "${MYSQL_PASSWORD}" -a "${MYSQL_USERNAME}"
    then
        cat /run/pdns-mysql.conf >> /run/pdns.conf
    else
        mkdir -p /opt/data/pdns
        db="/opt/data/pdns/pdns.db"
        {
        echo "launch=gsqlite3"
        echo "gsqlite3-dnssec=yes"
        echo "gsqlite3-database=${db}"
        } >> /run/pdns.conf

    	if ! test -f ${db}
    		then
				sqlite3 ${db} < /usr/local/etc/sqlite3.sql
			fi
    fi

mkdir -p /run/named/etc /run/named/var /run/named/zones /run/named/dev
chown named: /run/named/var /run/named/zones
chmod 755 /run/named/var /run/named/zones
cp /run/named.conf /run/named/etc/named.conf

src="blank.conf"
if test "${BIND_SECONDARY_SERVERS}"; then src="secondary_inc.conf"; fi
cp /run/${src} /run/named/etc/secondary_inc.conf

if ! named-checkconf -t /run/named -c /etc/named.conf
	then
		echo "ERROR: named-checkconf failed"
		exit 1
	fi
exec /sbin/init
